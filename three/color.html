<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Car Color Configuration</title>
  <style>
    body {
      margin: 0;
      padding: 0;
      font-family: Arial, sans-serif;
      background-color: rgb(185, 173, 230);
    }

    h1 {
      color: darkblue;
      text-align: center;
      padding: 20px;
      margin: 0;
    }


    .sidebar.active {
      margin-left: 0;
    }
    .sidebar-toggle {
      display: none;
      position: fixed;
      top: 15px;
      left: 15px;
      background: #3498db;
      color: white;
      border: none;
      border-radius: 4px;
      padding: 8px 12px;
      cursor: pointer;
      z-index: 1001;
    }

    @media (max-width: 768px) {
      .sidebar {
        margin-left: -250px;
      }
      .sidebar.active {
        margin-left: 0;
      }
      .sidebar-toggle {
        display: block;
      }
    }

    .nav-container {
      padding: 20px 0;
    }

    .logo {
      text-align: center;
      padding: 20px 10px;
      margin-bottom: 20px;
      border-bottom: 1px solid #02080e;
    }

    .nav-menu {
      list-style: none;
      padding: 0;
      margin: 0;
    }

    .nav-link {
      align-items: center;
      appearance: none;
      background-color: #fcfcfd;
      border-radius: 4px;
      border-width: 0;
      box-shadow:
        rgba(45, 35, 66, 0.2) 0 2px 4px,
        rgba(45, 35, 66, 0.15) 0 7px 13px -3px,
        #d6d6e7 0 -3px 0 inset;
      box-sizing: border-box;
      color: #36395a;
      cursor: pointer;
      display: inline-flex;
      height: 48px;
      justify-content: center;
      line-height: 1;
      list-style: none;
      overflow: hidden;
      padding-left: 16px;
      padding-right: 16px;
      position: relative;
      text-align: left;
      text-decoration: none;
      transition:
        box-shadow 0.15s,
        transform 0.15s;
      user-select: none;
      -webkit-user-select: none;
      touch-action: manipulation;
      white-space: nowrap;
      will-change: box-shadow, transform;
      font-size: 18px;
    }

    .nav-link:hover {
      box-shadow: rgba(45, 35, 66, 0.3) 0 4px 8px,
          rgba(45, 35, 66, 0.2) 0 7px 13px -3px,
            #d6d6e7 0 -3px 0 inset;
      transform: translateY(-2px);

    }

    .nav-link.active {
      box-shadow: #d6d6e7 0 3px 7px inset;
  transform: translateY(2px);
}
    

    .back-arrow {
      position: absolute;
      left: 20px;
      top: 50%;
      transform: translateY(-50%);
      color: white;
      text-decoration: none;
      font-size: 24px;
      transition: color 0.3s;
    }

    .back-arrow:hover {
      color: #3498db;
    }

    .content {
      flex: 1;
      margin-left: 250px;
      padding: 20px;
      max-width: calc(100% - 250px);
      transition: all 0.3s;
    }

    .content.expanded {
      margin-left: 0;
      max-width: 100%;
    }

    @media (max-width: 768px) {
      .content {
        margin-left: 0;
        max-width: 100%;
        padding: 20px 10px 20px 60px;
      }
    }

    h1 {
      color: #2c3e50;
      text-align: center;
      margin-bottom: 30px;
    }

    .color-options {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
      gap: 20px;
      margin-top: 30px;
    }

    .color-option {
      background: white;
      border-radius: 8px;
      padding: 15px;
      text-align: center;
      cursor: pointer;
      transition: transform 0.2s, box-shadow 0.2s;
      box-shadow: 0 2px 5px rgba(0,0,0,0.1);
    }

    .color-option:hover {
      transform: translateY(-5px);
      box-shadow: 0 5px 15px rgba(0,0,0,0.1);
    }

    .color-swatch {
      width: 100%;
      height: 100px;
      border-radius: 4px;
      margin-bottom: 10px;
    }

    .color-name {
      font-weight: bold;
      color: #2c3e50;
    }
  </style>
</head>
<body>
  <div class="content" style="padding-top: 20px;">
    <h1>Choose Your Car Color</h1>
    <div style="display: flex; gap: 30px; margin-top: 20px;">
      <!-- 3D Model Preview -->
       <div id="viewer" style="width: 800px; height: 400px; position: relative;"></div>
       
      
      <!-- Color Controls -->
      <div style="flex: 1; background: white; border-radius: 10px; padding: 20px; box-shadow: 0 2px 10px rgba(0,0,0,0.1);">
        <div class="tab-buttons" style="display: flex; margin-bottom: 20px; border-bottom: 1px solid #eee;">
          <button class="tab-button active" data-tab="body-tab" style="flex: 1; padding: 10px; border: none; background: none; cursor: pointer; border-bottom: 2px solid #3498db;">Body</button>
          <button class="tab-button" data-tab="wheel-tab" style="flex: 1; padding: 10px; border: none; background: none; cursor: pointer;">Wheels</button>
        </div>
        <div id="colorPopup" class="popup-overlay">
          <div class="popup-content">
            <span class="close-button" id="closePopup">&times;</span>
            <h2>Color Applied</h2>
            <p>Your selected color has been applied to the car model.Please use the below option to show your applied colour.</p>
          </div>
        </div>
        
        
        <!-- Body Tab -->
        <div id="body-tab" class="tab-content" style="display: block;">
          <h3>Body Color</h3>
          <input type="color" id="color-picker" style="width: 100%; height: 50px; margin: 15px 0;">
          
          <div style="margin: 20px 0;">
            <label style="display: block; margin-bottom: 5px;">Metallic: <span id="metallic-value">0.7</span></label>
            <input type="range" id="metallic" min="0" max="1" step="0.1" value="0.7" style="width: 100%;">
          </div>
          
          <div style="margin: 20px 0;">
            <label style="display: block; margin-bottom: 5px;">Roughness: <span id="roughness-value">0.3</span></label>
            <input type="range" id="roughness" min="0" max="1" step="0.1" value="0.3" style="width: 100%;">
          </div>
        </div>
        <!----background image-->
        <select id="backgroundSelector">
          <option value="/assests/garage2.jpeg">City</option>
          <option value="/assests/garage3.jpeg">Mountains</option>
          <option value="/assests/Garage.jpg">Desert</option>
        </select>
        
        
          
          <div style="margin: 20px 0;">
            <label style="display: block; margin-bottom: 5px;">Metallic: <span id="wheel-metallic-value">0.8</span></label>
            <input type="range" id="wheel-metallic" min="0" max="1" step="0.1" value="0.8" style="width: 100%;">
          </div>
          
          <div style="margin: 20px 0;">
            <label style="display: block; margin-bottom: 5px;">Roughness: <span id="wheel-roughness-value">0.2</span></label>
            <input type="range" id="wheel-roughness" min="0" max="1" step="0.1" value="0.2" style="width: 100%;">
          </div>
        </div>
        
        
        <style>
          .popup-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            display: none; /* Hidden by default */
            justify-content: center;
            align-items: center;
            z-index: 1000;
          }

/* Popup Content */
.popup-content {
  background-color: #fff;
  padding: 20px;
  border-radius: 10px;
  text-align: center;
  position: relative;
  width: 300px;
}

/* Close Button */
.close-button {
  position: absolute;
  top: 10px;
  right: 15px;
  font-size: 24px;
  cursor: pointer;
}

          .color-palette {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-bottom: 15px;
          }
          .color-option {
            width: 60px;
            text-align: center;
            cursor: pointer;
            padding: 5px;
            border-radius: 4px;
            transition: transform 0.2s;
            position: relative;
            overflow: hidden;
          }
          .color-option:hover {
            transform: scale(1.05);
          }
          .color-swatch {
            width: 50px;
            height: 30px;
            margin: 0 auto 5px;
            border-radius: 3px;
            border: 1px solid #ddd;
          }
          .color-name {
            font-size: 12px;
            color: #333;
          }
          .custom-color {
            position: relative;
          }
        </style>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Three.js and related scripts -->
  <script type="importmap">
    {
      "imports": {
        "three": "https://unpkg.com/three@0.158.0/build/three.module.js",
        "three/addons/": "https://unpkg.com/three@0.158.0/examples/jsm/"
      }
    }
  </script>
  <script type="module">
    import * as THREE from 'three';
    import { GLTFLoader } from 'three/addons/loaders/GLTFLoader.js';
    import { OrbitControls } from 'three/addons/controls/OrbitControls.js';

    // Three.js variables
    let scene, camera, renderer, carModel, controls, currentMaterial;
    
    // DOM elements
    let colorPicker, metallicSlider, roughnessSlider, customColorInput;
    
    // Model loading variables
    const modelPaths = [
      'models/free_-_mclaren_p1_mso.glb',
      'free_-_mclaren_p1_mso.glb',
      'car.glb',
      'models/car.glb'
    ];
    let currentPathIndex = 0;
    
    // Initialize after DOM is loaded
    document.addEventListener('DOMContentLoaded', () => {
      try {
        // Get DOM elements
        colorPicker = document.getElementById('color-picker');
        metallicSlider = document.getElementById('metallic');
        roughnessSlider = document.getElementById('roughness');
        const colorPopup = document.getElementById('colorPopup');
        const closePopup = document.getElementById('closePopup');

        // customColorInput = document.getElementById('custom-color');
        
        if (!colorPicker || !metallicSlider || !roughnessSlider) {
          throw new Error('Required DOM elements not found');
        }
      
        // Initialize 3D scene
        init();
        
        // Set up color selection
        setupColorSelection();
        
        // Add event listeners for material properties
        if (metallicSlider) metallicSlider.addEventListener('input', updateMaterial);
        if (roughnessSlider) roughnessSlider.addEventListener('input', updateMaterial);

        // Load saved settings if they exist
        const savedColor = localStorage.getItem('carColor');
        const savedMetallic = localStorage.getItem('carMetallic');
        const savedRoughness = localStorage.getItem('carRoughness');
        
        if (savedColor && colorPicker) {
          colorPicker.value = savedColor;
          if (customColorInput) customColorInput.value = savedColor;
        }
        if (savedMetallic && metallicSlider) {
          metallicSlider.value = savedMetallic;
        }
        if (savedRoughness && roughnessSlider) {
          roughnessSlider.value = savedRoughness;
        }
      } catch (error) {
        console.error('Initialization error:', error);
        const errorElement = document.createElement('div');
        errorElement.style.color = 'red';
        errorElement.style.padding = '20px';
        errorElement.textContent = `Error: ${error.message}`;
        document.body.appendChild(errorElement);
      }
    });
    

    // Debug function to log all mesh names and materials
    function logAllMeshNames() {
      if (carModel) {
        console.log('=== Mesh Information ===');
        carModel.traverse((child) => {
          if (child.isMesh) {
            console.group('Mesh:', child.name);
            console.log('Parent:', child.parent?.name || 'none');
            console.log('Material type:', child.material.type);
            console.log('Material properties:', {
              color: child.material.color,
              metalness: child.material.metalness,
              roughness: child.material.roughness,
              envMap: !!child.material.envMap,
              needsUpdate: child.material.needsUpdate
            });
            console.groupEnd();
          }
        });
      }
    }
    function showPopup() {
  colorPopup.style.display = 'flex';
}
function hidePopup() {
  colorPopup.style.display = 'none';
}


    // Update material when controls change
    function updateMaterial() {
      if (!carModel || !colorPicker || !metallicSlider || !roughnessSlider) {
        console.log('Required elements not found');
        return;
      }
      
      const color = colorPicker.value;
      
      // Log mesh information on first run
      if (typeof updateMaterial.firstRun === 'undefined') {
        logAllMeshNames();
        updateMaterial.firstRun = false;
      }
      
      // Update the custom color input to match
      if (customColorInput) {
        customColorInput.value = color;
      }
      
      console.log('Updating material with color:', color);
      applyColorToModel(color);
      
      // Save the current settings to localStorage
      localStorage.setItem('carColor', color);
      localStorage.setItem('carMetallic', metallicSlider.value);
      localStorage.setItem('carRoughness', roughnessSlider.value);
    }
    
    // Add event listeners
    colorPicker.addEventListener('input', updateMaterial);
    metallicSlider.addEventListener('input', updateMaterial);
    roughnessSlider.addEventListener('input', updateMaterial);
    
    // Add click handlers for color options
    document.querySelectorAll('.color-option').forEach(option => {
      option.addEventListener('click', function() {
        const color = this.getAttribute('data-color');
        if (color) {
          colorPicker.value = color;
          updateMaterial();
        }
      });
    });

        
    // Initialize the 3D scene
    function init() {
      console.log('Initializing 3D scene...');
      // Create scene
      scene = new THREE.Scene();
      scene.background = new THREE.Color(0xf5f5f5);
      
      // Create camera
      const viewer = document.getElementById('viewer');
      camera = new THREE.PerspectiveCamera(75, viewer.offsetWidth / viewer.offsetHeight, 0.1, 1000);
      camera.position.set(4, 5, 11);
      camera.lookAt(0, 1, 0);
      
      // Create renderer
      renderer = new THREE.WebGLRenderer({ antialias: true });
      renderer.setSize(viewer.offsetWidth, viewer.offsetHeight);
      renderer.shadowMap.enabled = true;
      renderer.shadowMap.type = THREE.PCFSoftShadowMap;
      renderer.setClearColor(0xf0f0f0);
      viewer.appendChild(renderer.domElement);
      
      // Add lights
      const ambientLight = new THREE.AmbientLight(0xffffff, 0.5);
      scene.add(ambientLight);

      const directionalLight = new THREE.DirectionalLight(0xffffff, 1);
      directionalLight.position.set(5, 10, 5);
      directionalLight.castShadow = true;
      scene.add(directionalLight);
      
      const directionalLight2 = new THREE.DirectionalLight(0xffffff, 1);
      directionalLight2.position.set(5, 10, 7);
      directionalLight2.castShadow = true;
      scene.add(directionalLight2);
      
      // Initialize OrbitControls
      controls = new OrbitControls(camera, renderer.domElement);
      controls.enableDamping = true;
      controls.dampingFactor = 0.05;
      controls.minDistance = 3;
      controls.maxDistance = 15;
      controls.minPolarAngle = 0.2; // Prevent camera from going below the ground
      controls.maxPolarAngle = Math.PI * 0.9; // Prevent camera from going upside down
      controls.enablePan = true;
      controls.autoRotate = false;
      controls.autoRotateSpeed = 0.5;
      controls.target.set(0, 0.5, 0);
      
      // Load car model
      const loader = new GLTFLoader();
      const loadingElement = document.getElementById('loading');
      
      if (loadingElement) {
        loadingElement.textContent = 'Loading 3D model...';
      }
      
      // Start trying to load the model
      tryLoadNextPath();
    }
    
    // Function to try loading model from different paths
    function tryLoadNextPath() {
      const loadingElement = document.getElementById('loading');
      
      if (currentPathIndex >= modelPaths.length) {
        console.error('Failed to load model from all paths');
        if (loadingElement) {
          loadingElement.textContent = 'Failed to load 3D model. Please check if the model file exists.';
        }
        return;
      }
      
      const modelPath = modelPaths[currentPathIndex++];
      console.log(`Trying to load model from: ${modelPath}`);
      
      const loader = new GLTFLoader();
      
      loader.load(
        modelPath,
        (gltf) => {
          try {
            console.log('Model loaded successfully from:', modelPath);
            carModel = gltf.scene;
            
            // Set up shadows and scale
            carModel.traverse((child) => {
              if (child.isMesh) {
                // Set up shadows
                child.castShadow = true;
                child.receiveShadow = true;
                
                // Enable mipmapping for better texture quality
                if (child.material) {
                  if (child.material.map) {
                    child.material.map.anisotropy = renderer.capabilities.getMaxAnisotropy();
                  }
                  // Ensure materials are using physically correct lighting
                  child.material.needsUpdate = true;
                }
                
                // Log material info for debugging
                console.log('Mesh:', child.name, 'Material:', child.material);
              }
            });
            
            // Center and scale the model
            const box = new THREE.Box3().setFromObject(carModel);
            const center = box.getCenter(new THREE.Vector3());
            const size = box.getSize(new THREE.Vector3());
            
            // Calculate scale to fit in view
            const maxDim = Math.max(size.x, size.y, size.z);
            const scale = 5 / maxDim;
            
            carModel.scale.set(scale, scale, scale);
            carModel.position.sub(center.multiplyScalar(scale)); // Center the model
            carModel.position.y = -size.y * scale * 0.5; // Place on ground
            scene.add(carModel);

           
            // Hide loading indicator
            if (loadingElement) {
              loadingElement.style.display = 'none';
            }
            
            // Apply saved settings if they exist
            const savedColor = localStorage.getItem('carColor') || '#ff0000'; // Default to red if no color saved
            if (colorPicker) {
              colorPicker.value = savedColor;
              updateMaterial(); // <- Replace this


            }
            
            // Force render after a short delay to ensure everything is ready
            setTimeout(() => {
              renderer.render(scene, camera);
            }, 100);
            
            // Start animation loop
            animate();
            
          } catch (error) {
            console.error('Error processing model:', error);
            if (loadingElement) {
              loadingElement.textContent = 'Error processing model. Check console for details.';
            }
          }
        },
        undefined,
        (error) => {
          console.error(`Error loading model from ${modelPath}:`, error);
          // Try the next path
          tryLoadNextPath();
        }
      );
    }
    
    // Start trying to load the model
    tryLoadNextPath();
    
    // Start animation loop
    function animate() {
      requestAnimationFrame(animate);
      if (controls) {
        controls.update();
        // Rotate the car model
        if (carModel) {
          carModel.rotation.y += 0.002; // Slow rotation
        }
      }
      renderer.render(scene, camera);
    }
    
    // Initial call to handle any initial resize
    onWindowResize();
    
    // Start the animation loop
    animate();
    
    // Handle window resize
    window.addEventListener('resize', onWindowResize);
    
    // Apply color to the model
    function applyColorToModel(colorHex) {
      if (!carModel) {
        console.log('No car model loaded yet');
        return;
      }
      
      const color = new THREE.Color(colorHex);
      const metallic = parseFloat(metallicSlider.value);
      const roughness = parseFloat(roughnessSlider.value);
      
      console.log('Applying color to body:', colorHex, 'metallic:', metallic, 'roughness:', roughness);
      
      // List of parts that should be considered as body parts
      const bodyParts = [
       'shell', 'main_body', 'panel', 'roof', 'door', 'body', 'cover'
      ];
      
      // List of parts that should NEVER be colored
      const excludedParts = [
        'glass', 'window', 'light', 'headlight', 'taillight', 'mirror',
        'tire', 'wheel', 'rim', 'interior', 'seat', 'steering', 'dashboard',
        'brake', 'caliper', 'rotor', 'disc', 'grill', 'grille', 'badge', 'emblem',
        'wiper', 'antenna', 'exhaust', 'pipe', 'muffler', 'intake', 'engine', 'motor'
      ];
      
      let paintedCount = 0;
      let skippedCount = 0;
      
      carModel.traverse((child) => {
        if (child.isMesh) {
          const lowerName = child.name.toLowerCase();
          
          // Check if this part should be excluded
        // const isExcluded = excludedParts.some(part => lowerName.includes(part));
        //  const isBodyPart = bodyParts.some(part => lowerName.includes(part));
          const isExcluded = false;
          const isBodyPart = true;
          // For debugging
          console.log('Checking part:', child.name, '| Is body part:', isBodyPart, '| Is excluded:', isExcluded);
          
          if (isExcluded || !isBodyPart) {
            console.log('Skipping part:', child.name);
            skippedCount++;
            return; // Skip to next part
          }
          
          // If we get here, the part should be painted
          try {
            console.log('Painting body part:', child.name, 'color:', color, 'metallic:', metallic, 'roughness:', roughness);
            paintedCount++;
            
            // Create a new material with the current settings
            const newMaterial = new THREE.MeshPhysicalMaterial({
              color: color,
              metalness: metallic,
              roughness: roughness,
              clearcoat: 1.0,
              clearcoatRoughness: 0.1
            });
            
            // Copy existing maps if they exist
            if (child.material.map) newMaterial.map = child.material.map;
            if (child.material.normalMap) newMaterial.normalMap = child.material.normalMap;
            if (child.material.roughnessMap) newMaterial.roughnessMap = child.material.roughnessMap;
            if (child.material.metalnessMap) newMaterial.metalnessMap = child.material.metalnessMap;
            if (child.material.envMap) newMaterial.envMap = child.material.envMap;
            
            // Apply the new material
            child.material = newMaterial;
            child.material.needsUpdate = true;
            
            // Force update the matrix
            child.updateMatrix();
          } catch (error) {
            console.error('Error painting part:', child.name, error);
          }
        }
      });
      
      console.log(`Applied color to ${paintedCount} body parts, skipped ${skippedCount} parts`);
    }
    scene.background = skyboxTexture;
    const fileInput = document.getElementById('fileInput');
    fileInput.addEventListener('change', (event) => {
      const file = event.target.files[0];
      const reader = new FileReader();
      reader.onload = function(e) {
        const texture = new THREE.TextureLoader().load(e.target.result);
        scene.background = texture;
      };
      reader.readAsDataURL(file);
    });

    // Handle window resize
    function onWindowResize() {
      const viewer = document.getElementById('viewer');
      if (viewer && camera && renderer) {
        const width = viewer.offsetWidth;
        const height = Math.max(400, window.innerHeight * 0.7); // Responsive height
        
        camera.aspect = width / height;
        camera.updateProjectionMatrix();
        renderer.setSize(width, height);
        
        // Re-render
        renderer.render(scene, camera);
      }
    }
    
    // Initialize the 3D viewer
    init();
  
    function updateColor(color) {
  // Example: apply the selected color to a car preview element
  const carPreview = document.getElementById('car-preview');
  if (carPreview) {
    carPreview.style.backgroundColor = color;
  }
}
    // Function to handle color selection
    function setupColorSelection() {
      // Handle color selection from palette
      document.querySelectorAll('.color-option:not(.custom-color)').forEach(option => {
        // Remove any existing listeners to prevent duplicates
        option.replaceWith(option.cloneNode(true));
      });
      
      // Add new listeners
      document.querySelectorAll('.color-option:not(.custom-color)').forEach(option => {
        option.addEventListener('click', function(e) {
          e.stopPropagation();
          const color = this.getAttribute('data-color');
          console.log('Color selected:', color);
          // Update the color picker to match
          if (colorPicker) {
            colorPicker.value = color;
          }
          updateColor(color);
          // Save to localStorage
          localStorage.setItem('carColor', color);
        });
      });
      const backgroundSelector = document.getElementById('backgroundSelector');
const textureLoader = new THREE.TextureLoader();

backgroundSelector.addEventListener('change', (event) => {
  const selectedImage = event.target.value;
  textureLoader.load(selectedImage, (texture) => {
    texture.colorSpace = THREE.SRGBColorSpace; // Ensures correct color rendering
    scene.background = texture;
  });
});

// Set default background on initial load
textureLoader.load('assests/whiteng.avif', (texture) => {
  texture.colorSpace = THREE.SRGBColorSpace;
  scene.background = texture;
});

      // Handle custom color selection
      if (customColorInput) {
        customColorInput.addEventListener('input', function() {
          const color = this.value;
          console.log('Custom color selected:', color);
          // Update the color picker to match
          if (colorPicker) {
            colorPicker.value = color;
          }
          updateColor(color);
          // Save to localStorage
          localStorage.setItem('carColor', color);
        });
      }
      
      // Handle color picker changes
      if (colorPicker) {
        colorPicker.addEventListener('input', function() {
          const color = this.value;
          console.log('Color picker changed:', color);
          updateColor(color);
          showPopup();
          closePopup.addEventListener('click', hidePopup);


          // Save to localStorage
          localStorage.setItem('carColor', color);
        });
      }
    }
  
  </script>
</body>
</html>